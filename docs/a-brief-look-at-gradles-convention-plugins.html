<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    A brief look at Gradle&amp;#8217;s convention plugins - Jordan&#39;s Blog
    
  </title>

  <meta name="description" content="Gradle is the glue that binds our code together that allows us to build an Android application. Exposure to Gradle can range from limited to deep knowledge p...">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://www.jordanterry.co.uk/a-brief-look-at-gradles-convention-plugins">
  <link rel="alternate" type="application/rss+xml" title="Jordan&#39;s Blog" href="/feed.xml">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Jordan&#39;s Blog</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

  <header class="masthead">
    
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>A brief look at Gradle&#8217;s convention plugins</h1>
            
            <span class="meta">Posted by
              <a href="#">jordan_terry</a>
              on December 12, 2022 &middot; <span class="reading-time" title="Estimated read time">
  
   7 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <p>Gradle is the glue that binds our code together that allows us to build an Android application. Exposure to Gradle can range from limited to deep knowledge producing plugins. Mine currently sits somewhere in the middle. I’m currently working on levelling it.</p>

<p>My topic of focus over the past few weeks has been <strong>Convention Plugins</strong>. This post is the culmination of what I’ve learned and it helps me frame Convention Plugins for my mental model. This is by no means a solid resource!</p>

<p>Multi-project applications are nearing the standard for Android codebases*. Sharing your build logic and rules across modules is important for a number of reasons:</p>

<ul>
  <li>As team size grows you want to maintain consistency in how modules are created</li>
  <li>Misconfigured project can impact your task graph causing inflated build times.</li>
  <li><strong>D</strong>on’t <strong>R</strong>epeat <strong>Y</strong>ourself. The more you repeat the easier it is for a mistake to creep in. It’s even harder to make co-ordinated changes.</li>
</ul>

<p>Here are concrete examples to help:</p>

<ul>
  <li>Applying the same Jvm source version across all modules for Java or Kotlin</li>
  <li>Applying the same Dagger settings across all modules that require dependency injection</li>
  <li>Applying the same Kotlin compiler flags across all Kotlin modules.</li>
  <li>Applying a consistent min and compile SDK version for Android across modules</li>
</ul>

<p>You get the idea. If you’ve been around for a while these might stick out as issues you have had to solve. Convention Plugins can help us solve these problems with idiomatic Gradle.</p>

<p>The majority of my experience with this in the past has been to apply scripts in relevant modules, use <code class="language-plaintext highlighter-rouge">subprojects</code> or <code class="language-plaintext highlighter-rouge">allprojects</code> blocks or put logic in <code class="language-plaintext highlighter-rouge">buildSrc</code>.</p>

<p>I am used to working with complicated Gradle files. Which can make fixing issues miserable! Does this look familiar?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;pre class="wp-block-code"&gt;```
plugins {
    id("kotlin-android")
    id("kotlin-kapt")
  id("com.android.library")
    id("dagger.hilt.android.plugin")
}

android {
    minSdk 30
    defaultConfig {
    minSdk = 21
    targetSdk = 30
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8.toString()
        targetCompatibility = JavaVersion.VERSION_1_8.toString()
    }
    kotlinOptions {
        jvmTarget = '1.8'
    }
}


</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
You may then have a similar Gradle file across many projects. Moving to Java 11 suddenly becomes a manual process. You can ease the pain by using project wide variables to hold values. You can remove the pain with a Convention Plugin.

## What is a Convention Plugin?

A convention plugin allows us to define configurations, or conventions, for builds that we re-use across a project.

A convention is represented by a Gradle script or a Plugin. They will live in a build logic module that will register plugins with Gradle. The module is then applied via your `pluginManagement` .

</code></pre></div></div>
<pre class="wp-block-code">```
pluginManagement {
    includeBuild("build-logic")
}
```
```

Once included all projects can access your plugin.

But what can a convention plugin do? Anything a normal Gradle script or Plugin can do!

- Apply plugins to a project (e.g. Kotlin, Android plugins or Kapt)
- Configure extensions or tasks associated with an applied plugin
- Add dependencies to a project

One of the real benefits to me is that it makes Gradle build files feel more life software. You can write plugins using apply bread and butter principles like: cohesion, coupling and composition. You can write tests, making your build file feel predictable.

## A Kotlin convention plugin

Here’s a simple example of how we can create a Kotlin convention:

```
<pre class="wp-block-code">```
class KotlinConventionPlugin : Plugin<Project> {
    override fun apply(target: Project) {
        target.pluginManager.apply("org.jetbrains.kotlin.jvm")
        target.tasks.withType<KotlinCompile> {
             kotlinOptions.jvmTarget = JavaVersion.VERSION_1_8.toString()
        }
    }
}
```
```

We can then add this to the build using the `build.gradle.kts` file in our `build-logic` module.

```
<pre class="wp-block-code">```
gradlePlugin {
    plugins {
        register("kotlinApplication") {
            id = "example.kotlin"
            implementationClass = "KotlinConventionPlugin"
        }
    }
}
```
```

A project can then apply this like any other plugin.

```
<pre class="wp-block-code">```
plugins {
    id("example.kotlin)
}
```
```

If you want to update the JVM target you can do that in a single file and have all projects update.

## A Hilt convention plugin

On its own, a Kotlin plugin is less exciting. I think a compelling use case is when we think about applying an annotation processor and then the libraries that use it.

When creating conventions we should split conventions logically. For example, if we want to use hilt in a project.

Hilt is a dependency injection library that uses kapt. We can write a convention plugin as follows:

```
<pre class="wp-block-code">```
class HiltConventionPlugin : Plugin<Project> {
    override fun apply(target: Project) {
    with(target) {
        with(pluginManager) {
            apply("org.jetbrains.kotlin.kapt")
            apply("dagger.hilt.android.plugin")
        }
        dependencies {
            add("implementation", "com.google.dagger:hilt-android:2.44")
            add("kapt", "com.google.dagger:hilt-android-compiler:2.44")
        }
    }
}
```
```

This library applies the kapt plugin, hilt plugin and adds the related dependencies. The dependencies here are hard coded as an example but you should make use of the VersionCatalog extension like this:

```
<pre class="wp-block-code">```
val libs = extensions.getByType<VersionCatalogsExtension>().named("libs")
dependencies {
    "implementation"(libs.findLibrary("hilt.android").get())
    "kapt"(libs.findLibrary("hilt.compiler").get())
}
```
```

We can register the plugin:

```
<pre class="wp-block-code">```
register("hiltConvention") {
    id = "example.hilt"
    implementationClass = "HiltConventionPlugin"
}
```
```

Then apply it:

```
<pre class="wp-block-code">```
plugins {
    id("example.hilt")
}
```
```

Now, updating the version or swapping from `kapt` to `ksp` only needs a developer to change a single plugin. Not many projects.

# Better resources

This scratches the surface. There are many incredible resources out there to help you get started.

- [Gradle docs](https://docs.gradle.org/current/samples/sample_convention_plugins.html) – A brief look at a sample use case from the folk at Square.
- [Herding Elephants by Tony Robalik](https://developer.squareup.com/blog/herding-elephants/) – A high level overview of how Square use convention plugins to make their monorepo manageable!
- [Now in Android](https://github.com/android/nowinandroid) – A fantastic resource to help you delve into a multi-project code base. This serves as a good base for you to build into more complex solutions.
- [Exploring Now in Android Gradle Convention Plugins by Adam Ahmed](https://proandroiddev.com/exploring-now-in-android-gradle-convention-plugins-91983825bcd7)
- I’d encourage reading Dan Luu’s “In defence of simple architecture” – &lt;https://danluu.com/simple-architectures/&gt; – to reason if your app needs many modules
</pre></pre></VersionCatalogsExtension></pre></Project></pre></pre></pre></KotlinCompile></Project></pre></pre>


        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/type-ii-pain" data-toggle="tooltip" data-placement="top" title="Type II Pain">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/professional-triathlon-has-a-data-problem" data-toggle="tooltip" data-placement="top" title="Professional triathlon has a data problem">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:jordanfterry+blog@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy;  2023</p>
      </div>
    </div>
  </div>
</footer>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/scripts.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



</body>

</html>
